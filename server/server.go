package main

import (
	"bytes"
	"encoding/hex"
	"fmt"
	"github.com/rajnikant12345/kmip_g/objects"
	"github.com/rajnikant12345/kmip_g/operations"
	"github.com/rajnikant12345/kmip_g/parser"
	"io"
)

func KmipLoop(conn io.ReadWriter) {
	var res *objects.KmipStructResponse
	dec,_ := parser.NewDecoder(conn)
	req := objects.KmipStruct{}
	err := dec.Decode(&req)

	if err != nil {
		res = operations.MakeKmipResponse(err)
	}else {
		res = operations.DoKmip(&req)
	}


	encd,_ := parser.NewEncoder(conn)

	encd.Encode(res)
}

func main() {

	in  := bytes.Buffer{}
	d, _ := hex.DecodeString("42007801000002B042007701000000E8420069010000002042006A0200000004000000010000000042006B0200000004000000020000000042000C01000000A842002301000000A04200240500000004000000020000000042002501000000884200B0070000000C7365724E756D313233343536000000004200A1070000000673656372657400004200A20700000009646576494432323333000000000000004200AB07000000096E6574494439303030000000000000004200A9070000000A6D616368696E654944310000000000004200AA070000000A6D65646961494433313300000000000042000D0200000004000000010000000042000F01000001B842005C0500000004000000010000000042007901000001A0420057050000000400000002000000004200910100000188420008010000003042000A070000001743727970746F6772617068696320416C676F726974686D0042000B05000000040000000300000000420008010000003042000A070000001443727970746F67726170686963204C656E6774680000000042000B02000000040000008000000000420008010000003042000A070000001843727970746F67726170686963205573616765204D61736B42000B02000000040000000C00000000420008010000004042000A07000000044E616D650000000042000B0100000028420055070000000E54432D3131322D31322D6B657931000042005405000000040000000100000000420008010000003042000A07000000154F7065726174696F6E20506F6C696379204E616D6500000042000B070000000764656661756C7400420008010000005842000A070000001843727970746F6772617068696320506172616D657465727342000B01000000304200110500000004000000010000000042005F0500000004000000030000000042003805000000040000000400000000")
	in.Write(d)
	KmipLoop(&in)

	fmt.Println(hex.EncodeToString(d))
	fmt.Println(hex.EncodeToString(in.Bytes()))

}